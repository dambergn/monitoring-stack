# my-monitoring-stack-ip/nginx/nginx.conf

events {} # Nginx requires this block, even if empty.

http {
    server {
        listen 80;

        # --- Redirect for trailing slashes ---
        # This ensures that http://<ip>/grafana gets redirected to http://<ip>/grafana/
        # which is needed for relative paths to work correctly.
        rewrite ^/portainer$ /portainer/ permanent;
        rewrite ^/grafana$ /grafana/ permanent;
        rewrite ^/prometheus$ /prometheus/ permanent;

        # --- Portainer Proxy ---
        location /portainer/ {
            # Strip the /portainer/ prefix from the request
            rewrite ^/portainer/(.*)$ /$1 break;
            
            # Required for websocket connection
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            proxy_set_header Host $host;
            proxy_pass https://portainer:9443;
        }

        # --- Grafana Proxy ---
        location /grafana/ {
            # Strip the /grafana/ prefix
            rewrite ^/grafana/(.*)$ /$1 break;
            
            proxy_set_header Host $host;
            proxy_pass http://grafana:3100/;
        }

        # --- Prometheus Proxy ---
        location /prometheus/ {
            # Strip the /prometheus/ prefix
            rewrite ^/prometheus/(.*)$ /$1 break;
            
            proxy_set_header Host $host;
            proxy_pass http://prometheus:9090/;
        }
    }
}