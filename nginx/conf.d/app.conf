# my-monitoring-stack-ip/nginx/nginx.conf
# --- FINAL VERSION ---

events {
    worker_connections 1024;
}

http {
    server {
        listen 80;

        # --- REDIRECTS ---
        # Ensures a trailing slash is added to the URL.
        location = /portainer { return 301 /portainer/; }
        location = /grafana { return 301 /grafana/; }
        location = /prometheus { return 301 /prometheus/; }


        # --- Portainer Proxy (HTTPS Backend) ---
        location /portainer/ {
            # Required for websocket connection
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            proxy_set_header Host $host;
            rewrite ^/portainer/(.*)$ /$1 break;
            
            # CRITICAL: Use https and the correct port
            proxy_pass https://portainer:9443;
            
            # CRITICAL: Tell Nginx to NOT verify Portainer's self-signed SSL cert.
            # Without this, you will get a 502 Bad Gateway error.
            proxy_ssl_verify off;
        }

        # --- Grafana Proxy (Custom Port) ---
        location /grafana/ {
            proxy_set_header Host $host;
            # CRITICAL: Use the custom port 3100
            proxy_pass http://grafana:3100/;
        }

        # --- Prometheus Proxy (Standard Port) ---
        location /prometheus/ {
            proxy_set_header Host $host;
            proxy_pass http://prometheus:9090/;
        }
    }
}